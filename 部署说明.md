# MoonTV 一键部署包

## 📦 包含文件

- `docker-compose.yml` - Docker Compose 配置文件
- `config.json` - MoonTV 配置文件
- `start.bat` - Windows 一键启动脚本
- `stop.bat` - Windows 一键停止脚本
- `start.sh` - Linux/macOS 一键启动脚本
- `stop.sh` - Linux/macOS 一键停止脚本
- `部署说明.md` - 本说明文档

## 🚀 快速开始

### Windows 用户

1. **确保已安装 Docker Desktop**
   - 下载地址：https://www.docker.com/products/docker-desktop
   - 安装后启动 Docker Desktop

2. **一键启动**
   ```cmd
   双击运行 start.bat
   ```

3. **访问服务**
   - 浏览器打开：http://localhost:3000
   - 默认账号：`admin`
   - 默认密码：`yezi`

4. **停止服务**
   ```cmd
   双击运行 stop.bat
   ```

### Linux/macOS 用户

1. **确保已安装 Docker 和 Docker Compose**
   ```bash
   # Ubuntu/Debian
   sudo apt update
   sudo apt install docker.io docker-compose
   
   # CentOS/RHEL
   sudo yum install docker docker-compose
   
   # macOS (使用 Homebrew)
   brew install docker docker-compose
   ```

2. **添加执行权限**
   ```bash
   chmod +x start.sh stop.sh
   ```

3. **一键启动**
   ```bash
   ./start.sh
   ```

4. **访问服务**
   - 浏览器打开：http://localhost:3000
   - 默认账号：`admin`
   - 默认密码：`yezi`

5. **停止服务**
   ```bash
   ./stop.sh
   ```

## ⚙️ 自定义配置

### 修改密码

编辑 `docker-compose.yml` 文件，修改以下环境变量：

```yaml
environment:
  - USERNAME=你的用户名
  - PASSWORD=你的密码
```

### 修改端口

编辑 `docker-compose.yml` 文件，修改端口映射：

```yaml
ports:
  - '8080:3000'  # 将 3000 改为你想要的端口
```

### 修改资源站点

编辑 `config.json` 文件，添加或删除资源站点。

### 开启用户注册

编辑 `docker-compose.yml` 文件：

```yaml
environment:
  - NEXT_PUBLIC_ENABLE_REGISTER=true
```

## 🔧 高级配置

### 数据持久化

默认配置已启用 Redis 数据持久化，数据存储在 Docker 卷中。

### 备份数据

```bash
# 备份 Redis 数据
docker exec moontv-redis redis-cli BGSAVE
docker cp moontv-redis:/data/dump.rdb ./backup-$(date +%Y%m%d).rdb
```

### 恢复数据

```bash
# 停止服务
docker-compose down

# 恢复数据
docker run --rm -v moontv_redis-data:/data -v $(pwd):/backup alpine cp /backup/dump.rdb /data/

# 重启服务
docker-compose up -d
```

## 🌐 外网访问

### 局域网访问

1. 确保防火墙允许 3000 端口
2. 使用服务器 IP 地址访问：`http://服务器IP:3000`

### 公网访问（需要域名）

1. **使用 Nginx 反向代理**

```nginx
server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

2. **使用 Cloudflare Tunnel**

```bash
# 安装 cloudflared
curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
sudo dpkg -i cloudflared.deb

# 创建隧道
cloudflared tunnel --url http://localhost:3000
```

## 🛠️ 故障排除

### 常见问题

1. **端口被占用**
   ```bash
   # 查看端口占用
   netstat -tulpn | grep 3000
   # 或修改 docker-compose.yml 中的端口
   ```

2. **Docker 服务未启动**
   ```bash
   # Linux
   sudo systemctl start docker
   
   # Windows
   # 启动 Docker Desktop
   ```

3. **镜像拉取失败**
   ```bash
   # 使用国内镜像源
   docker pull registry.cn-hangzhou.aliyuncs.com/senshinya/moontv:latest
   ```

4. **服务无法访问**
   - 检查防火墙设置
   - 确认容器正在运行：`docker ps`
   - 查看容器日志：`docker logs moontv`

### 查看日志

```bash
# 查看所有服务日志
docker-compose logs

# 查看特定服务日志
docker-compose logs moontv
docker-compose logs moontv-redis

# 实时查看日志
docker-compose logs -f
```

## 📞 技术支持

如遇到问题，请提供以下信息：

1. 操作系统版本
2. Docker 版本：`docker --version`
3. 错误日志：`docker-compose logs`
4. 容器状态：`docker ps -a`

---

**享受 MoonTV 带来的观影体验！** 🎬